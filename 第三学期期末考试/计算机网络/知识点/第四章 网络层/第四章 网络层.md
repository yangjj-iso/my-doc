# 计算机网络自顶向下方法：第四章 网络层（数据平面）深度复习报告

## 1. 绪论：网络层的核心地位与架构演进

在计算机网络的分层体系结构中，网络层（Network Layer）无疑占据着最为核心的地位。它是整个协议栈中唯一贯穿网络边缘（Edge）与网络核心（Core）的层次，负责将数据包（Datagram）从源主机（Source Host）一路传输到目的主机（Destination Host）。对于正在学习詹姆斯·库罗斯（James F. Kurose）和基思·罗斯（Keith W. Ross）所著《计算机网络：自顶向下方法》（Computer Networking: A Top-Down Approach）第八版的读者而言，理解第四章的关键在于把握现代网络架构的一个根本性转变：**数据平面（Data Plane）与控制平面（Control Plane）的分离**。

本章的内容不再是孤立地讨论路由算法，而是聚焦于网络层中“每台路由器”（per-router）的局部功能——数据平面。这种视角的转换反映了软件定义网络（SDN）兴起后的行业现状。在复习过程中，我们需要构建一个从微观的比特处理到宏观的架构设计的完整知识体系。

### 1.1 数据平面与控制平面的二分法架构

传统的网络教学往往将路由选择（路径计算）与分组转发（数据搬运）混为一谈。然而，随着网络规模的指数级增长和SDN技术的普及，将这两个功能在逻辑上甚至物理上进行解耦已成为必然。

#### 1.1.1 转发（Forwarding）：数据平面的微观操作

转发是网络层最基本、最核心的功能。它指的是将数据包从路由器的输入链路接口移动到适当的输出链路接口的**本地**动作 1。

- **时间尺度**：转发通常在纳秒（nanosecond）级的时间尺度上发生。这意味着转发逻辑必须由硬件直接实现，以适应高速光纤链路的线速（Line Speed）要求。
    
- **实现机制**：转发决策主要依赖于路由器的转发表（Forwarding Table）。当一个分组到达时，路由器提取其首部字段（如目的IP地址），在转发表中进行查找匹配，然后通过交换结构（Switching Fabric）将其导向正确的输出端口。
    
- **类比**：如果将网络比作从北京驾车前往上海的旅程，转发就是在每一个十字路口（路由器）看到路牌后，决定是直行、左转还是右转的瞬间动作。
    

#### 1.1.2 路由（Routing）：控制平面的宏观决策

路由则是指确定数据包从源到目的地所经过的**全局**路径的网络范围的处理过程 1。

- **时间尺度**：路由计算通常在秒（second）级的时间尺度上发生，通常由复杂的软件算法（如OSPF、BGP）完成。
    
- **实现机制**：路由算法负责收集网络拓扑信息，计算最佳路径，并最终生成指导转发的转发表。
    
- **传统与现代的对比**：
    
    - **传统架构（每路由器控制）**：路由算法运行在每一台路由器中，路由器既负责计算路径（控制平面），也负责转发数据（数据平面）。
        
    - **SDN架构（逻辑集中控制）**：控制平面从路由器中剥离，移至远程的控制器（Remote Controller）。路由器变得更加单纯和高效，只负责执行控制器下发的流表规则 3。
        

### 1.2 网络服务模型（Network Service Models）

网络层向传输层提供的服务模型决定了整个网络的复杂性分布。互联网的设计哲学是著名的“端到端原则”，即保持网络核心的简单性。

|**服务模型**|**描述**|**保证内容**|**适用场景**|
|---|---|---|---|
|**尽力而为 (Best-Effort)**|互联网IP协议采用的模型。网络层尽可能发送数据，但不做任何承诺。|**无**。不保证交付、不保证顺序、不保证时延、不保证带宽、不保证抖动。|电子邮件、Web浏览、文件传输（依靠TCP保证可靠性）；现代流媒体（依靠应用层缓冲适应）。|
|**恒定比特率 (CBR)**|早期ATM网络模型。模拟电路交换，提供固定带宽。|恒定带宽、低时延、无丢包。|传统的实时语音电话。|
|**可变比特率 (VBR)**|ATM网络模型。允许速率在一定范围内波动。|保证平均速率和峰值速率。|压缩视频流。|

深入洞察：

尽管“尽力而为”听起来像是劣质服务，但它恰恰是互联网成功的关键。因为不提供复杂的质量保证（QoS），网络核心的路由器可以设计得非常简单、高速且低成本。这种简单的架构具有极强的适应性，能够运行在从双绞线到卫星链路的任何物理介质上。所有的复杂性（如重传、排序、流控）都被推向了网络边缘的主机（Host）。在复习时，必须深刻理解这种**“哑核心、智边缘”（Dumb Core, Smart Edge）**的设计理念 5。

---

## 2. 路由器内部结构深度解析：从输入到输出

第四章的一个核心技术点是“路由器里面有什么”（What's Inside a Router）。这部分内容揭示了数据包在硬件层面是如何被处理的。一个高性能路由器并非一台运行Linux的普通PC，而是一个高度专用的硬件系统，旨在消除任何可能导致性能瓶颈的环节。

### 2.1 路由器的高层组件架构

路由器主要由四个组件构成，复习时需重点关注数据信号在这些组件间的流动路径以及潜在的瓶颈位置 7：

1. **输入端口（Input Ports）**：执行物理层终结、链路层解封装以及最关键的**查找与转发**功能。
    
2. **交换结构（Switching Fabric）**：路由器的核心，负责将数据包从输入端口物理地“搬运”到输出端口。
    
3. **输出端口（Output Ports）**：存储从交换结构传来的数据包，并将其发送到输出链路。
    
4. **路由选择处理器（Routing Processor）**：执行控制平面功能。在传统路由器中，它运行路由协议并维护路由表；在SDN路由器中，它负责与远程控制器通信。
    

### 2.2 输入端口：线速查找的挑战

输入端口不仅仅是插网线的接口，它是一台极其复杂的处理单元。其核心任务是在纳秒级时间内完成“查找”（Lookup）操作。

#### 2.2.1 查找机制与最长前缀匹配（LPM）

转发表中存储的不是具体的IP地址，而是目的网络的**前缀（Prefix）**。当一个数据包到达时，路由器必须在转发表中找到与该数据包目的地址匹配的所有条目中，**掩码最长**（即最具体）的那个。

示例分析 9：

假设转发表包含以下条目：

- 条目A: `192.168.0.0/16`
    
- 条目B: `192.168.20.0/24`
    

若目的地址为 `192.168.20.5`：

- 它匹配条目A（前16位匹配）。
    
- 它也匹配条目B（前24位匹配）。
    
- 根据LPM规则，路由器选择**条目B**，因为它更具体。
    

#### 2.2.2 硬件实现：TCAM

为了在数百万条路由条目中实现线速查找，单纯的软件搜索（如二分查找）太慢了。现代路由器使用**三态内容寻址存储器（TCAM）**。

- **CAM vs RAM**：在RAM中，你提供地址，它返回数据。在CAM中，你提供数据（IP地址），它返回该数据存储的地址（即匹配的行）。
    
- **三态（Ternary）**：TCAM不仅支持0和1，还支持“Don't Care”（通配符）。这使得它能够完美支持CIDR掩码匹配。TCAM可以在**一个时钟周期**内并行检索所有条目，是高性能路由器的标配 11。
    

### 2.3 交换结构：带宽的瓶颈

交换结构决定了路由器的内部吞吐量。书中介绍了三种主要的交换技术，必须掌握它们的区别和性能瓶颈 6：

|**交换技术**|**架构描述**|**性能特征与瓶颈**|**典型应用**|
|---|---|---|---|
|**经内存交换 (Switching via Memory)**|最早期的架构。输入端口通过中断通知CPU，CPU将数据包从输入缓冲区复制到内存，再复制到输出缓冲区。|**双重总线跨越**。每个数据包需两次通过系统总线（读+写）。吞吐量受限于内存带宽的一半 ($B/2$)。|早期路由器、现代低端软件路由器（如基于Linux的软路由）。|
|**经总线交换 (Switching via Bus)**|输入端口预先为数据包加上内部标签，直接通过共享总线发送到输出端口。|**总线争用**。同一时刻总线上只能传输一个数据包。交换速率受限于总线带宽。|中低端企业级路由器（如Cisco 5600系列）。|
|**经互联网络交换 (Switching via Interconnection Network)**|使用纵横式开关（Crossbar）或多级交换网络（如Banyan）。|**非阻塞并行转发**。只要不同的输入端口去往不同的输出端口，就可以同时传输。具有最高的扩展性。|高端核心路由器（如Cisco 12000系列、运营商级路由器）。|

### 2.4 排队与丢包机制

无论交换结构多么快，当流量到达速率超过处理或发送速率时，必然发生排队。理解排队发生的地点对于理解网络拥塞至关重要。

#### 2.4.1 输入排队与线头阻塞（HOL Blocking）

如果交换结构的速度慢于所有输入端口的总到达速度，数据包会在输入端口排队。这里有一个著名的现象：**线头阻塞（Head-of-the-Line Blocking, HOL）**。

- **现象描述**：排在输入队列头部的那个数据包（红色包）想要去的输出端口正忙，它被阻塞了。排在它后面的第二个数据包（绿色包）想要去的输出端口明明是空闲的，但因为它被前面的红色包挡住了，也无法发送。
    
- **影响**：HOL阻塞严重限制了输入排队交换机的理论吞吐量（约为58%），是设计高性能交换机必须解决的问题（通常通过虚拟输出队列VOQ解决） 4。
    

#### 2.4.2 输出排队与主动队列管理（AQM）

即使交换结构足够快，当多个输入端口同时向同一个输出端口发送数据时，瞬时速率可能超过输出链路带宽，导致输出端口排队。这是**丢包（Packet Loss）**最常发生的地方。

- **弃尾（Tail Drop）**：最简单的丢包策略，队列满时丢弃新到达的包。但这可能导致所有TCP连接同时进入慢启动（全局同步）。
    
- **主动队列管理（AQM）**：如随机早期检测（RED）。在队列完全填满之前，根据平均队列长度概率性地丢弃数据包。这相当于给TCP发送一个隐式的拥塞信号，诱导其减速，从而避免灾难性的连续丢包。
    

#### 2.4.3 分组调度算法

当输出端口积压了大量数据包时，先发送哪一个？复习时需了解以下几种调度策略：

1. **先进先出（FIFO）**：默认策略，简单但无法提供QoS。
    
2. **优先权排队（Priority Queueing）**：严格优先级。高优先级队列（如VoIP）只要有包就先发。可能导致低优先级流量“饿死”。
    
3. **循环排队（Round Robin, RR）**：在多个类别队列间轮询。
    
4. **加权公平排队（Weighted Fair Queueing, WFQ）**：通用的调度算法。每个队列分配一定的权重（带宽比例），保证每个业务流都能获得公平的资源，同时防止饿死 13。
    

---

## 3. 网际协议 (IPv4)：从数据报格式到编址

这一部分是第四章的基石，也是考试中计算题的高发区。我们需要深入每一个比特，理解IPv4的设计精髓。

### 3.1 IPv4 数据报格式详析

需要记忆并理解IP头部的关键字段及其设计意图 3：

|**字段名称**|**长度**|**功能描述与现代用法**|
|---|---|---|
|**Version**|4 bits|指明协议版本（4或6）。路由器据此决定如何解析后续字段。|
|**Header Length**|4 bits|指明首部长度，单位为4字节。最小值为5（即20字节），最大为15（60字节）。|
|**TOS (DiffServ)**|8 bits|原名服务类型，现用于区分服务（DiffServ）。前6位为DSCP，用于QoS标记；后2位为ECN，用于显式拥塞通知。|
|**Total Length**|16 bits|数据报总长度（首部+数据），单位字节。最大理论值为65,535字节。|
|**Identification**|16 bits|唯一标识主机发送的一个数据报。用于分片重组。|
|**Flags**|3 bits|标志位。第1位保留；第2位DF（Don't Fragment）；第3位MF（More Fragments）。|
|**Fragment Offset**|13 bits|片偏移。指明分片在原数据报中的位置，**以8字节为单位**。|
|**TTL**|8 bits|生存时间。每经过一个路由器减1，减至0丢弃。防止环路导致数据包无限循环。|
|**Protocol**|8 bits|上层协议标识（TCP=6, UDP=17, ICMP=1）。体现了分层复用思想。|
|**Header Checksum**|16 bits|首部校验和。**只校验首部**。每跳都需要重新计算（因为TTL变了）。|
|**Source/Dest IP**|32 bits|源和目的IP地址。|

**深度洞察**：

- **校验和的冗余性**：为什么IP层要有校验和，传输层（TCP/UDP）也要有，链路层（Ethernet）还有CRC？这是一个历史遗留问题。IPv6直接取消了首部校验和，认为链路层和端到端校验已经足够，从而加速了路由器的转发处理。
    
- **TTL的作用**：TTL不仅防止环路，还被`traceroute`工具巧妙利用。通过发送TTL=1, 2, 3...的数据包，诱发沿途路由器返回ICMP超时报文，从而描绘出路径。
    

### 3.2 IP 分片与重组：机制与计算

这是一个极易出错的计算点。由于物理链路层的**最大传输单元（MTU）**限制（如以太网MTU通常为1500字节），大的IP数据报必须被切分。

#### 3.2.1 分片规则

1. **分片发生地**：通常在源主机或路径上的路由器（IPv4）。
    
2. **重组发生地**：**仅在目的主机**。中间路由器不负责重组，以减轻核心网络负担。
    
3. **MTU限制**：MTU限制的是**IP首部 + 数据载荷**的总和。
    
4. **偏移量对齐**：除了最后一个分片，所有分片的数据长度必须是 **8字节的倍数**。
    

#### 3.2.2 分片攻击与安全

分片机制带来了一些安全隐患：

- **Teardrop攻击**：构造重叠的偏移量，导致操作系统在重组时崩溃。
    
- **微小分片攻击**：将TCP头部切分到两个分片中，使得防火墙无法在第一个分片中看到端口号，从而绕过过滤规则。
    
- **Ping of Death**：构造总长度超过65535字节的分片包，导致接收端溢出。
    

由于这些问题以及分片对路由器性能的消耗，现代网络倾向于使用**路径MTU发现（PMTUD）**技术，即发送设置了DF=1的探测包，自动协商出路径上最小的MTU，从而避免分片 15。

### 3.3 IPv4 编址：从分类到CIDR

IP地址不仅仅是一个ID，它具有层次结构（网络号 + 主机号）。

#### 3.3.1 历史演进

- **分类编址（Classful Addressing）**：A类（/8）、B类（/16）、C类（/24）。这种划分过于僵化，导致了B类地址的极度短缺和C类地址的路由表膨胀。
    
- **CIDR（无类别域间路由）**：现代标准。取消了类的概念，使用斜线记法 `a.b.c.d/x`，其中 `x` 是子网掩码长度（前缀长度）。CIDR允许任意长度的前缀，极大地提高了地址利用率，并支持路由聚合（Route Aggregation）。
    

#### 3.3.2 子网划分计算要点

在复习计算题时，必须熟练掌握以下公式：

- **子网掩码（Subnet Mask）**：网络位全1，主机位全0。
    
- **网络地址**：IP地址 AND 子网掩码。
    
- **广播地址**：网络地址 OR (NOT 子网掩码)。即主机位全1。
    
- **可用主机数**：$2^{\text{主机位数}} - 2$（减去网络地址和广播地址）。
    

---

## 4. 网络层的控制与配置辅助协议

IP协议并非孤军奋战，它有一系列辅助协议来完成配置、地址转换和错误报告。

### 4.1 DHCP：动态主机配置协议

当你的笔记本电脑连上WiFi时，它是如何自动获取IP地址的？DHCP是这一过程的关键。DHCP不仅分配IP，还配置子网掩码、默认网关和DNS服务器。

#### 4.1.1 DORA 四步握手流程

这是一个基于UDP的应用层协议（虽然服务于网络层配置）。由于客户端初始没有IP，通信主要依赖**广播** 17。

| **步骤** | **报文名称**          | **方向**              | **源IP**   | **目的IP**                | **关键内容与作用**                                     |
| ------ | ----------------- | ------------------- | --------- | ----------------------- | ----------------------------------------------- |
| **1**  | **DHCP Discover** | Client -> Broadcast | `0.0.0.0` | `255.255.255.255`       | 客户端喊话：“有人能给我个IP吗？” 包含事务ID。                      |
| **2**  | **DHCP Offer**    | Server -> Client    | Server IP | `255.255.255.255` (或单播) | 服务器回应：“我这有个IP 192.168.1.100，租期24小时，你要吗？”        |
| **3**  | **DHCP Request**  | Client -> Broadcast | `0.0.0.0` | `255.255.255.255`       | 客户端确认：“好的，我选这个IP了。” **广播**是为了通知其他服务器撤销它们的Offer。 |
| **4**  | **DHCP ACK**      | Server -> Client    | Server IP | `255.255.255.255` (或单播) | 服务器确认：“配置生效，这是你的详细参数。”                          |

**细节补充**：DHCP报文是封装在UDP中的，客户端使用端口68，服务器使用端口67。

### 4.2 NAT：网络地址转换

NAT解决了IPv4地址耗尽的问题，但也破坏了IP的端到端原则，使得P2P通信变得困难。

#### 4.2.1 工作原理与转换表

路由器维护一张**NAT转换表（NAT Translation Table）**。

- **出站（WAN方向）**：将内网数据包的 `(源IP, 源端口)` 替换为 `(NAT公网IP, 新端口)`。
    
- **入站（LAN方向）**：收到回包时，根据 `(目的IP, 目的端口)` 查表，还原为 `(内网IP, 原始端口)`。
    

#### 4.2.2 NAT穿透（Traversal）

由于内网主机没有公网IP，外网无法主动发起连接。解决方法包括：

1. **静态NAT/端口转发**：手动在路由器配置映射。
    
2. **UPnP**：允许主机自动配置路由器的映射。
    
3. **中继（Relaying）**：如Skype使用超级节点进行流量中转。
    

### 4.3 ICMP：互联网控制报文协议

ICMP被认为是IP的一部分，但它承载在IP数据报中。它主要用于错误报告和网络探测。

- **报文类型**：
    
    - **Type 0/8**：Echo Reply / Request (Ping)。
        
    - **Type 3**：Destination Unreachable (目的不可达)。细分为网络不可达、主机不可达、端口不可达、需要分片但DF置位等代码（Code）20。
        
    - **Type 11**：Time Exceeded (TTL超时)，用于Traceroute。
        

---

## 5. IPv6：下一代网际协议的变革

IPv6的引入主要是为了解决IPv4地址耗尽的问题，但也借机对协议首部进行了大量的工程优化。

### 5.1 IPv6 数据报格式的优化

22

对比IPv4，IPv6头部做出了激进的简化：

1. **地址空间扩大**：从32位增加到**128位**。
    
2. **固定首部长度**：固定为**40字节**。这使得路由器硬件处理更加简单高效，无需解析变长字段。
    
3. **取消分片**：IPv6路由器**不再进行分片**。如果包太大，直接丢弃并回发ICMPv6 "Packet Too Big"。这迫使端系统进行PMTUD，减轻了网络核心的负担。
    
4. **取消首部校验和**：移除了Checksum字段。因为现代链路层（如光纤、以太网）误码率极低，且传输层已有校验，移除该字段消除了路由器每次转发都要重新计算校验和的开销。
    
5. **流标签（Flow Label）**：新增字段，用于标识属于同一业务流的数据包，便于实施QoS。
    
6. **下一个首部（Next Header）**：取代了Protocol字段。它指向数据部分的第一个扩展首部（如分片扩展头、路由扩展头），形成链表结构。
    

### 5.2 迁移策略：隧道（Tunneling）

由于互联网规模庞大，无法在一夜之间升级所有设备。主要的过渡技术是**隧道**。

- **机制**：当两个IPv6孤岛需要经过IPv4海洋通信时，将整个IPv6数据报作为**载荷**封装在IPv4数据报中。
    
- **过程**：IPv6主机 -> 双栈路由器（封装进IPv4） -> IPv4网络 -> 双栈路由器（解封装） -> IPv6主机。
    

---

## 6. 通用转发与SDN：数据平面的革命

这是第八版教材的亮点，反映了从“基于目的IP的转发”向“通用转发”的演进。

### 6.1 匹配-动作（Match-plus-Action）范式

在通用转发中，转发设备不再仅仅是路由器，而被称为**分组交换机（Packet Switch）**。其转发表（流表）更加强大。

- **匹配（Match）**：不再局限于目的IP。可以匹配链路层（MAC地址、VLAN）、网络层（源/目IP、协议）、传输层（端口号）等10多个字段 25。
    
- **动作（Action）**：
    
    - **转发**：到一个或多个端口（负载均衡、组播）。
        
    - **丢弃**：实现防火墙功能。
        
    - **修改字段**：重写IP/MAC/TTL，实现NAT功能。
        
    - **封装**：实现隧道功能。
        

这种抽象极其强大，它统一了路由器、交换机、防火墙、NAT和负载均衡器的功能。在SDN中，这些都只是流表中的不同规则而已。

### 6.2 OpenFlow 协议

OpenFlow是SDN控制器与数据平面交换机通信的标准接口。它定义了流表的结构以及控制器如何下发、修改和删除流表项。掌握OpenFlow的匹配规则对于理解现代数据中心网络至关重要。

---

## 7. 综合实战演练与解析

为了巩固上述知识，以下设计了几个具有代表性的综合题目，涵盖了第四章最核心的计算和逻辑推理。这些题目比一般的课后习题更具综合性。

### 题目一：复杂子网划分设计（Subnet Addressing）

场景描述：

你拥有一个CIDR地址块 200.10.10.0/24。你需要划分出三个子网，并按顺序分配：

1. **子网A**：需要支持 60 台主机。
    
2. **子网B**：需要支持 20 台主机。
    
3. 子网C：需要支持 10 台主机。
    
    要求：尽可能节省地址空间，并按 A -> B -> C 的顺序紧凑分配，计算每个子网的CIDR地址块、广播地址和可用IP范围。
    

解析：

步骤1：子网A (60主机)

- 需求：$60 + 2 = 62$ 个地址。
    
- 计算：$2^6 = 64$。需要6位主机位。掩码长度 $= 32 - 6 = /26$。
    
- 块大小：64。
    
- **Subnet A**: `200.10.10.0/26`
    
    - 范围：`.0` - `.63`
        
    - 广播地址：`200.10.10.63`
        
    - 可用IP：`.1` - `.62`
        

**步骤2：子网B (20主机)**

- 需求：$20 + 2 = 22$ 个地址。
    
- 计算：$2^5 = 32$。需要5位主机位。掩码长度 $= 32 - 5 = /27$。
    
- 块大小：32。
    
- 起始位置：紧接A之后，即 `.64`。
    
- **Subnet B**: `200.10.10.64/27`
    
    - 范围：`.64` - `.95`
        
    - 广播地址：`200.10.10.95`
        
    - 可用IP：`.65` - `.94`
        

**步骤3：子网C (10主机)**

- 需求：$10 + 2 = 12$ 个地址。
    
- 计算：$2^4 = 16$。需要4位主机位。掩码长度 $= 32 - 4 = /28$。
    
- 块大小：16。
    
- 起始位置：紧接B之后，即 `.96`。
    
- **Subnet C**: `200.10.10.96/28`
    
    - 范围：`.96` - `.111`
        
    - 广播地址：`200.10.10.111`
        
    - 可用IP：`.97` - `.110`
        

---

### 题目二：IP 分片深度计算（Fragmentation）

场景描述：

一个IP数据报，**总长度（Total Length）**为 4200字节（包含20字节首部）。该数据报需要通过一个MTU为 1400字节 的链路。请计算每个分片的详细字段。

解析：

关键约束：MTU=1400，IP头=20。最大载荷 = 1380字节。

陷阱：分片偏移量必须是8的倍数。

$1380 / 8 = 172.5$ (非整数)。因此，每个分片的最大数据长度必须向下取整到8的倍数：$172 \times 8 = 1376$ 字节。

这意味着，虽然MTU允许携带1380字节数据，但为了满足偏移量对齐要求，我们只能携带1376字节。

**原始数据量**：$4200 - 20 = 4180$ 字节。

|**分片序号**|**数据长度 (Bytes)**|**剩余数据**|**Total Length (数据+20)**|**MF Flag**|**Offset (数据/8)**|
|---|---|---|---|---|---|
|**1**|1376|2804|**1396**|1|**0**|
|**2**|1376|1428|**1396**|1|**172**|
|**3**|1376|52|**1396**|1|**344** (172+172)|
|**4**|52|0|**72**|0|**516** (344+172)|

**注意**：此题展示了MTU非8倍数时的特殊情况，即实际分片大小（1396）可能小于MTU（1400）。27

---

### 题目三：最长前缀匹配与TCAM模拟

场景描述：

路由器转发表如下：

1. `192.168.0.0/16` -> Iface 0
    
2. `192.168.20.0/24` -> Iface 1
    
3. `192.168.20.16/28` -> Iface 2
    

**问题**：数据包目的地址 `192.168.20.19` 发往哪个接口？

**解析**：

- **地址二进制**：`...20.19` -> `...00010100. 00010011`
    
- **匹配条目1 (/16)**：匹配 `192.168`。成功。
    
- **匹配条目2 (/24)**：匹配 `192.168.20`。成功。
    
- **匹配条目3 (/28)**：
    
    - 掩码/28要求匹配前3个字节（`192.168.20`）以及第4个字节的前4位。
        
    - `192.168.20.16` 的第4字节前4位是 `0001` (16 = 0001xxxx)。
        
    - 目的地址 `19` (00010011) 的前4位也是 `0001`。
        
    - **匹配成功**。
        
- **决策**：条目3的掩码长度（28）最长。
    
- **答案**：转发到 **Iface 2**。
    

---

### 题目四：OpenFlow 规则冲突与优先级

场景描述：

流表规则如下：

1. (Priority 10) `Src=10.0.0.1, Dest=*` -> Drop
    
2. (Priority 20) `Src=*, Dest=192.168.1.1` -> Forward(1)
    

**问题**：源IP为 `10.0.0.1`，目的IP为 `192.168.1.1` 的包如何处理？

解析：

该数据包同时匹配两条规则：

- 匹配规则1：因为源IP是 `10.0.0.1`。
    
- 匹配规则2：因为目的IP是 192.168.1.1。
    
    在OpenFlow中，当多条规则匹配时，优先级（Priority）数值高的规则生效。
    
- 规则2的优先级（20）高于规则1（10）。
    
- **答案**：执行 **Forward(1)**。
    
- **思考**：这模拟了“白名单”机制——虽然我想封锁来自10.0.0.1的所有流量（规则1），但如果它是去往特定服务器的（规则2），我允许通过。
    

---

## 8. 结语

掌握第四章《网络层：数据平面》不仅需要记忆字段和协议，更需要建立“数据流”的动态视角。从输入端口的TCAM查找，到交换结构的纵横调度，再到输出端口的队列管理，每一个环节都体现了计算机网络在速度、公平性和成本之间的精妙平衡。希望这份深度报告能帮助你不仅通过考试，更能从系统设计的角度理解互联网的基石。